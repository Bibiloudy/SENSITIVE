<!DOCTYPE html>

<html>
<head>
<style>
body {
  background: linear-gradient(135deg, #0d4f3c 0%, #1a5f47 50%, #0e3f32 100%);
  color: white;
  font-family: Arial;
  margin: 0;
  min-height: 100vh;
}
.container {
  background: rgba(255,255,255,0.1);
  padding: 50px;
  border-radius: 20px;
  text-align: center;
  max-width: 500px;
  backdrop-filter: blur(10px);
}
.screen {
  display: none;
  min-height: 100vh;
}
.screen.active {
  display: flex;
  align-items: center;
  justify-content: center;
}
.game-screen {
  display: none;
  height: 100vh;
  background: #000;
  position: relative;
  overflow: hidden;
}
.game-screen.active {
  display: block;
}

button {
background: rgba(229, 57, 53, 0.4);
color: rgba(255,255,255,0.7);
border: 1px solid rgba(229, 57, 53, 0.6);
padding: 15px 30px;
margin: 10px;
border-radius: 15px;
font-size: 1.1rem;
cursor: pointer;
width: 100%;
transition: all 0.3s ease;
}
button.ready {
background: rgba(229, 57, 53, 0.9);
color: white;
}
button:disabled {
background: rgba(100, 100, 100, 0.3);
cursor: not-allowed;
}

input {
width: 100%;
padding: 15px;
margin: 10px 0;
background: rgba(255,255,255,0.1);
border: 1px solid rgba(255,255,255,0.3);
border-radius: 10px;
color: white;
font-size: 1rem;
box-sizing: border-box;
}
input::placeholder { color: rgba(255,255,255,0.6); }

.role-btn {
background: rgba(255,255,255,0.1);
border: 1px solid rgba(255,255,255,0.3);
text-align: left;
padding: 20px;
transition: all 0.3s ease;
}
.role-btn:hover {
background: rgba(255,255,255,0.2);
}

.back-btn {
background: none;
border: none;
color: rgba(255,255,255,0.7);
margin-bottom: 20px;
width: auto;
padding: 10px;
}

/* Interface de jeu */
.game-header {
background: rgba(255,255,255,0.1);
padding: 15px 20px;
display: flex;
justify-content: space-between;
align-items: center;
}

.game-area {
position: absolute;
top: 60px;
left: 0;
right: 0;
bottom: 0;
display: flex;
}

.lane {
flex: 1;
position: relative;
border-right: 1px solid rgba(255,255,255,0.2);
cursor: pointer;
transition: background 0.2s ease;
}
.lane:last-child { border-right: none; }
.lane:hover { background: rgba(255,255,255,0.05); }

.hit-line {
position: absolute;
left: 0;
right: 0;
height: 4px;
background: white;
top: 66%;
box-shadow: 0 0 20px #ffffff;
z-index: 5;
}

.lane-label {
position: absolute;
top: 10px;
left: 10px;
font-size: 0.8rem;
opacity: 0.7;
z-index: 5;
}

.note {
position: absolute;
left: 5%;
width: 90%;
height: 40px;
border-radius: 5px;
display: flex;
align-items: center;
justify-content: center;
font-weight: bold;
color: #000;
transition: none;
z-index: 3;
}

.overlay {
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.8);
display: flex;
align-items: center;
justify-content: center;
z-index: 20;
}

.overlay-content {
background: rgba(255,255,255,0.1);
padding: 40px;
border-radius: 20px;
text-align: center;
max-width: 500px;
backdrop-filter: blur(10px);
}

.part-btn {
background: rgba(59, 130, 246, 0.7);
border: none;
text-align: left;
margin: 8px 0;
}

.countdown {
font-size: 6rem;
font-weight: bold;
margin: 20px 0;
text-shadow: 0 0 30px currentColor;
}

/* Couleurs des pistes */
.lane-0 { background: rgba(255, 107, 107, 0.1); }
.lane-1 { background: rgba(78, 205, 196, 0.1); }
.lane-2 { background: rgba(69, 183, 209, 0.1); }
.lane-3 { background: rgba(150, 206, 180, 0.1); }

.note-0 { background: #ff6b6b; }
.note-1 { background: #4ecdc4; }
.note-2 { background: #45b7d1; }
.note-3 { background: #96ceb4; }

.note-center-0 { background: #ff2020; border: 2px solid #ffffff; }
.note-center-1 { background: #00ffcc; border: 2px solid #ffffff; }
.note-center-2 { background: #0099ff; border: 2px solid #ffffff; }
.note-center-3 { background: #00ff66; border: 2px solid #ffffff; }

.section {
background: rgba(255,255,255,0.1);
padding: 25px;
border-radius: 15px;
margin: 20px 0;
backdrop-filter: blur(10px);
}

.musician-item {
display: flex;
justify-content: space-between;
padding: 10px;
background: rgba(255,255,255,0.1);
border-radius: 8px;
margin: 5px 0;
}

@media (max-width: 768px) {
.container { padding: 30px 20px; }
h1 { font-size: 2.5rem; }
.countdown { font-size: 4rem; }
}
</style>

</head>
<body>

<!-- S√âLECTION DE R√îLE -->

<div id="role-screen" class="screen active">
  <div class="container">
    <h1>SENSITIVE</h1>
    <h2>Choisissez votre r√¥le</h2>

```
<button class="role-btn" onclick="selectRole('composer')">
  <div style="font-size: 1.2rem; font-weight: bold;">üéº Compositeur</div>
  <div style="font-size: 0.9rem; opacity: 0.8;">Cr√©er une session, g√©rer les parties</div>
</button>

<button class="role-btn" onclick="selectRole('musician')">
  <div style="font-size: 1.2rem; font-weight: bold;">üéµ Musicien</div>
  <div style="font-size: 0.9rem; opacity: 0.8;">Rejoindre une session, jouer une partie</div>
</button>
```

  </div>
</div>

<!-- CONNEXION -->

<div id="connection-screen" class="screen">
  <div class="container">
    <button class="back-btn" onclick="backToRole()">‚Üê Retour</button>
    <h2 id="connection-title"></h2>

```
<input type="text" id="player-name" placeholder="Pr√©nom" oninput="updateButton()" onkeypress="handleEnter(event)" />
<button id="action-btn" onclick="connect()" disabled></button>
```

  </div>
</div>

<!-- INTERFACE COMPOSITEUR -->

<div id="composer-screen" class="screen">
  <div style="padding: 20px; min-height: 100vh;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
      <h2>üéº Session SENSITIVE</h2>
      <button style="width: auto; padding: 10px 20px;" onclick="backToRole()">üè† Menu</button>
    </div>

```
<div class="section">
  <h3 style="margin-bottom: 20px;">üë• Participants</h3>
  <div id="musicians-list">
    <p style="color: rgba(255,255,255,0.6);">Aucun musicien connect√©</p>
  </div>
  <button onclick="addTestMusicians()">+ Ajouter musiciens test</button>
</div>

<div class="section">
  <h3 style="margin-bottom: 20px;">üìÅ Parties MIDI</h3>
  <div id="parts-list">
    <p style="color: rgba(255,255,255,0.6);">Aucune partie charg√©e</p>
  </div>
  <button onclick="createTestParts()">üß™ Cr√©er parties de test</button>
</div>

<div class="section">
  <h3 style="margin-bottom: 20px;">üöÄ Contr√¥le</h3>
  <button style="background: rgba(34, 197, 94, 0.7); font-size: 1.3rem;" onclick="startSession()">
    ‚ñ∂ D√âMARRER LA SESSION
  </button>
  <p style="text-align: center; margin-top: 10px; font-size: 0.9rem; opacity: 0.7;">
    Parties: <span id="parts-count">0</span> | Musiciens: <span id="musicians-count">0</span>
  </p>
</div>
```

  </div>
</div>

<!-- INTERFACE MUSICIEN -->

<div id="musician-screen" class="game-screen">
  <div class="game-header">
    <span>üéµ Session SENSITIVE</span>
    <button style="background: rgba(100,100,100,0.6); border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;" onclick="backToRole()">üè†</button>
  </div>

  <div class="game-area" id="game-area"></div>

  <!-- S√©lection de partie -->

  <div id="part-selection" class="overlay">
    <div class="overlay-content">
      <h2>Choisir votre partie</h2>
      <div id="available-parts">
        <p style="color: rgba(255,255,255,0.6);">En attente des parties...</p>
      </div>
    </div>
  </div>

  <!-- Attente -->

  <div id="waiting" class="overlay" style="display: none;">
    <div class="overlay-content">
      <h2>üéµ Partie s√©lectionn√©e</h2>
      <div style="font-size: 1.2rem; color: #4caf50; margin: 15px 0;">
        Partie <span id="selected-part-num"></span>
      </div>
      <p style="color: #45b7d1;">En attente du d√©marrage...</p>
    </div>
  </div>

  <!-- D√©compte -->

  <div id="countdown" class="overlay" style="display: none;">
    <div class="overlay-content">
      <h2>D√©compte</h2>
      <div id="countdown-num" class="countdown" style="color: #ff6b6b;">1</div>
      <div id="countdown-text">Un</div>
      <p style="margin-top: 20px; font-size: 0.9rem; color: rgba(255,255,255,0.8);">
        Pr√©parez-vous √† cliquer sur les pistes quand les notes traversent la ligne blanche
      </p>
    </div>
  </div>
</div>

<script>
// Variables globales
let currentRole = '';
let playerName = '';
let availableParts = [];
let connectedMusicians = [];
let selectedPart = null;
let gamePhase = 'lobby';
let isPlaying = false;
let midiNotes = [];
let startTime = 0;
let activeNotes = new Set();

const laneColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4'];

// Navigation
function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
}

function selectRole(role) {
  currentRole = role;
  showScreen('connection-screen');

  document.getElementById('connection-title').textContent =
    role === 'composer' ? 'üéº Compositeur' : 'üéµ Musicien';

  document.getElementById('player-name').value = '';
  updateButton();
}

function updateButton() {
  const name = document.getElementById('player-name').value.trim();
  const btn = document.getElementById('action-btn');

  if (name.length >= 1) {
    btn.disabled = false;
    btn.classList.add('ready');
    btn.textContent = currentRole === 'composer' ? 'Cr√©er la session' : 'Rejoindre';
  } else {
    btn.disabled = true;
    btn.classList.remove('ready');
    btn.textContent = '';
  }
}

function handleEnter(event) {
  if (event.key === 'Enter' && !document.getElementById('action-btn').disabled) {
    connect();
  }
}

function connect() {
  const name = document.getElementById('player-name').value.trim();
  if (name.length < 1) {
    alert('Entrez votre nom');
    return;
  }

  playerName = name;

  if (currentRole === 'composer') {
    showScreen('composer-screen');
    createTestParts();
    updateStats();
  } else {
    showScreen('musician-screen');
    setupGameArea();
    createTestParts();
    updateAvailableParts();
    document.getElementById('part-selection').style.display = 'flex';
  }
}

function backToRole() {
  currentRole = '';
  playerName = '';
  availableParts = [];
  connectedMusicians = [];
  selectedPart = null;
  gamePhase = 'lobby';
  isPlaying = false;
  activeNotes.clear();

  document.getElementById('part-selection').style.display = 'flex';
  document.getElementById('waiting').style.display = 'none';
  document.getElementById('countdown').style.display = 'none';

  showScreen('role-screen');
}

// Interface compositeur
function addTestMusicians() {
  connectedMusicians = [
    { name: 'Alice', ready: true, part: 0 },
    { name: 'Bob', ready: false, part: null },
    { name: 'Charlie', ready: true, part: 1 }
  ];
  updateMusiciansList();
  updateStats();
}

function createTestParts() {
  availableParts = [
    {
      id: 0,
      name: 'M√©lodie Collective',
      fileName: 'melodie.mid',
      notes: createTestNotes(0)
    },
    {
      id: 1,
      name: 'Rythme Partag√©',
      fileName: 'rythme.mid',
      notes: createTestNotes(1)
    }
  ];
  updatePartsList();
  updateAvailableParts();
  updateStats();
}

function createTestNotes(partIndex) {
  const notes = [];
  const noteNames = ['Do', 'R√©', 'Mi', 'Fa', 'Sol', 'La', 'Si'];

  for (let i = 0; i < 12; i++) {
    notes.push({
      note: 60 + partIndex * 3 + i,
      time: i * 1200 + 6000,
      lane: i % 4,
      id: `${partIndex}-${i}`,
      noteName: noteNames[i % 7]
    });
  }
  return notes;
}

function updateMusiciansList() {
  const list = document.getElementById('musicians-list');
  if (connectedMusicians.length === 0) {
    list.innerHTML = '<p style="color: rgba(255,255,255,0.6);">Aucun musicien connect√©</p>';
    return;
  }

  list.innerHTML = '';
  connectedMusicians.forEach(m => {
    const div = document.createElement('div');
    div.className = 'musician-item';
    div.innerHTML = `
      <span>${m.name}</span>
      <span style="color: ${m.ready ? '#4caf50' : '#ffeb3b'};">
        ${m.part !== null ? `Partie ${m.part + 1}` : 'En attente'}
      </span>
    `;
    list.appendChild(div);
  });
}

function updatePartsList() {
  const list = document.getElementById('parts-list');
  if (availableParts.length === 0) {
    list.innerHTML = '<p style="color: rgba(255,255,255,0.6);">Aucune partie charg√©e</p>';
    return;
  }

  list.innerHTML = '';
  availableParts.forEach(p => {
    const div = document.createElement('div');
    div.style.cssText = 'padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; margin: 5px 0;';
    div.innerHTML = `
      <div style="font-weight: bold;">${p.name}</div>
      <div style="font-size: 0.9rem; color: #4caf50;">‚úÖ ${p.fileName}</div>
      <div style="font-size: 0.8rem; opacity: 0.7;">${p.notes.length} notes</div>
    `;
    list.appendChild(div);
  });
}

function updateStats() {
  document.getElementById('parts-count').textContent = availableParts.length;
  document.getElementById('musicians-count').textContent = connectedMusicians.length;
}

function startSession() {
  if (availableParts.length === 0) {
    alert('Cr√©ez d\'abord des parties de test !');
    return;
  }

  gamePhase = 'countdown';

  if (currentRole === 'musician' && selectedPart !== null) {
    document.getElementById('waiting').style.display = 'none';
    document.getElementById('countdown').style.display = 'flex';
    startCountdown();
  } else {
    alert('Session d√©marr√©e ! Les musiciens voient le d√©compte.');
  }
}

// Interface musicien
function setupGameArea() {
  const gameArea = document.getElementById('game-area');
  gameArea.innerHTML = '';

  for (let i = 0; i < 4; i++) {
    const lane = document.createElement('div');
    lane.className = `lane lane-${i}`;
    lane.onclick = () => clickLane(i);

    lane.innerHTML = `
      <div class="hit-line"></div>
      <div class="lane-label">Piste ${i + 1}</div>
    `;

    gameArea.appendChild(lane);
  }
}

function updateAvailableParts() {
  const container = document.getElementById('available-parts');
  if (availableParts.length === 0) {
    container.innerHTML = '<p style="color: rgba(255,255,255,0.6);">En attente des parties...</p>';
    return;
  }

  container.innerHTML = '';
  availableParts.forEach((part, index) => {
    const btn = document.createElement('button');
    btn.className = 'part-btn';
    btn.onclick = () => selectPart(index);
    btn.innerHTML = `
      <div style="font-weight: bold;">${part.name}</div>
      <div style="font-size: 0.9rem; opacity: 0.8;">${part.fileName}</div>
      <div style="font-size: 0.8rem;">${part.notes.length} notes</div>
    `;
    container.appendChild(btn);
  });
}

function selectPart(partIndex) {
  selectedPart = partIndex;
  midiNotes = availableParts[partIndex].notes;

  document.getElementById('part-selection').style.display = 'none';
  document.getElementById('waiting').style.display = 'flex';
  document.getElementById('selected-part-num').textContent = partIndex + 1;
}

function startCountdown() {
  let count = 1;
  const countdownNum = document.getElementById('countdown-num');
  const countdownText = document.getElementById('countdown-text');
  const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4'];
  const texts = ['Un', 'Deux', 'Trois', 'Quatre'];

  const interval = setInterval(() => {
    countdownNum.textContent = count;
    countdownNum.style.color = colors[count - 1];
    countdownText.textContent = texts[count - 1];

    count++;
    if (count > 4) {
      clearInterval(interval);
      setTimeout(() => {
        document.getElementById('countdown').style.display = 'none';
        startGame();
      }, 1000);
    }
  }, 1000);
}

function startGame() {
  isPlaying = true;
  gamePhase = 'playing';
  startTime = Date.now();
  animate();
}

function animate() {
  if (!isPlaying) return;

  const currentTime = Date.now() - startTime;

  // Nettoyer les anciennes notes
  document.querySelectorAll('.note').forEach(n => n.remove());

  // Afficher les notes actuelles
  midiNotes.forEach(note => {
    const position = ((6000 - (note.time - currentTime)) / 6000) * 100;

    if (position > -10 && position < 110) {
      const noteEl = document.createElement('div');
      const isOnCenter = position >= 64 && position <= 68;
      const isHit = activeNotes.has(note.id);

      noteEl.className = `note note-${note.lane}`;
      if (isOnCenter && !isHit) {
        noteEl.className += ` note-center-${note.lane}`;
        noteEl.style.transform = 'scale(1.1)';
      }
      if (isHit) {
        noteEl.style.opacity = '0.3';
      }

      noteEl.style.top = position + '%';
      noteEl.textContent = note.noteName || note.note;

      const lane = document.querySelector(`.lane-${note.lane}`);
      if (lane) lane.appendChild(noteEl);
    }
  });

  requestAnimationFrame(animate);
}

function clickLane(laneIndex) {
  if (!isPlaying) return;

  const currentTime = Date.now() - startTime;
  const hittableNotes = midiNotes.filter(note => {
    if (note.lane !== laneIndex || activeNotes.has(note.id)) return false;
    const position = ((6000 - (note.time - currentTime)) / 6000) * 100;
    return position >= 62 && position <= 70;
  });

  if (hittableNotes.length > 0) {
    const note = hittableNotes[0];
    activeNotes.add(note.id);

    console.log(`Note ${note.noteName || note.note} touch√©e !`);

    // Effet visuel de r√©ussite
    const lanes = document.querySelectorAll('.lane');
    if (lanes[laneIndex]) {
      lanes[laneIndex].style.background = 'rgba(76, 175, 80, 0.5)';
      setTimeout(() => {
        lanes[laneIndex].style.background = '';
      }, 300);
    }
  }
}

// Initialisation
showScreen('role-screen');
</script>

</body>
</html>
